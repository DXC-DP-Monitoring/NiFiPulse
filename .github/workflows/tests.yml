name: Tests

on:
  push:
    branches: [ dev ]
    paths-ignore:
      - '**/*.md'
      - 'images/**'
      - 'docs/**'
  pull_request:
    branches: [ dev, staging, main ]
    paths-ignore:
      - '**/*.md'
      - 'images/**'
      - 'docs/**'

jobs:
  unit-integration:
    if: !(
         github.event_name == 'push' && contains(github.event.head_commit.message, '[skip ci]') ||
         github.event_name == 'pull_request' && (contains(github.event.pull_request.title, '[skip ci]') || contains(github.event.pull_request.body, '[skip ci]'))
        )
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: metrics_db
        ports: [ '5432:5432' ]
        options: >-
          --health-cmd="pg_isready -U postgres -d metrics_db"
          --health-interval=5s --health-timeout=5s --health-retries=12
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          pip install -U pip
          pip install -e .
          pip install pytest "sqlalchemy>=2" psycopg2-binary pandas requests
      - name: Wait for Postgres
        run: |
          python - <<'PY'
          import time, psycopg2
          for _ in range(30):
              try:
                  psycopg2.connect(host="localhost", port=5432, user="postgres", password="postgres", dbname="metrics_db").close()
                  break
              except Exception: time.sleep(2)
          PY
      - name: Init schema
        run: |
          python - <<'PY'
          from sqlalchemy import create_engine, text
          eng = create_engine("postgresql+psycopg2://postgres:postgres@localhost:5432/metrics_db")
          ddl = """
          CREATE TABLE IF NOT EXISTS dim_instance (instance_id SERIAL PRIMARY KEY, instance_name TEXT UNIQUE NOT NULL);
          CREATE TABLE IF NOT EXISTS dim_metric (metric_id SERIAL PRIMARY KEY, metric_name TEXT UNIQUE NOT NULL, original_unit TEXT);
          CREATE TABLE IF NOT EXISTS dim_component (component_id SERIAL PRIMARY KEY, component_name TEXT NOT NULL, component_type TEXT NOT NULL, UNIQUE (component_name, component_type));
          CREATE TABLE IF NOT EXISTS dim_date (date_id SERIAL PRIMARY KEY, timestamp_utc TIMESTAMPTZ UNIQUE NOT NULL, year INT, month INT, day INT, hour INT, minute INT, second INT);
          CREATE TABLE IF NOT EXISTS fact_metrics (fact_id SERIAL PRIMARY KEY, date_id INT REFERENCES dim_date(date_id), instance_id INT REFERENCES dim_instance(instance_id), metric_id INT REFERENCES dim_metric(metric_id), component_id INT REFERENCES dim_component(component_id), value DOUBLE PRECISION, UNIQUE (date_id, instance_id, metric_id, component_id));
          """
          with eng.begin() as c:
              for s in [x.strip() for x in ddl.split(';') if x.strip()]:
                  c.execute(text(s))
          PY
      - name: Run tests
        run: pytest -q